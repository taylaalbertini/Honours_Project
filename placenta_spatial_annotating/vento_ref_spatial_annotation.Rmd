---
title: "vento_ref_spatial_annotation"
output: html_document
date: "2024-08-09"
---

# load libraries and set data directory
```{r}
library(Seurat)
library(SeuratObject)
library(ggplot2)
library(tidyverse)
library(data.table)
```

# make Seurat object
```{r}
# set data directory
data_dir <- "/Users/taylaalbertini/Desktop/R studio/honours_project/placenta_spatial_annotating/outs"

# check data is there
list.files(data_dir) # Should show filtered_feature_bc_matrix.h5

# seu for Seurat
seu <- Load10X_Spatial(data.dir = data_dir, slice='sample1')
View(seu)
View(seu@meta.data)

# View image in Seurat object
SpatialPlot(seu, pt.size.factor = 1.3, alpha = 1) + 
  NoLegend() + 
  ggtitle('my Visium data') + 
  theme(plot.title = element_text(hjust = 0.5))
```

# data QC and violin plot
```{r}
## nCount = no of molecules / transcripts
## nFeature = no of genes
## MT = mitochondrial

# calculate % MT content per spot
# capital MT for human data. Lower case mt for mouse
seu <- PercentageFeatureSet(seu, "^MT-", col.name = "percent_mito")

head(seu) # a new column should now be there called "percent_mito"

# Vln plot QC data
VlnPlot(seu, features = c("nCount_Spatial", "nFeature_Spatial", "percent_mito"), 
        pt.size = 0.1, 
        group.by = 'orig.ident') + NoLegend()

seu # check dimensions of object

## QC Trim objects individually
# filter data. Change these values based on your data and the violin plots
seu_fil <- subset(seu, subset = nCount_Spatial > 800 & 
                    nFeature_Spatial > 500 & 
                    percent_mito < 10)

# Vln again after filtering
VlnPlot(seu_fil, features = c("nCount_Spatial", "nFeature_Spatial", "percent_mito"), 
        pt.size = 0.1, 
        group.by = 'orig.ident') + NoLegend()

## see where there are high counts in the image 
SpatialFeaturePlot(seu, features = "nCount_Spatial") +
  SpatialFeaturePlot(seu_fil, features = "nCount_Spatial") 

seu_fil
```

# pre-processing using Seurat
```{r}
## Seurat Workflow
seu_fil <- NormalizeData(seu_fil) ## normalise the data
seu_fil <- FindVariableFeatures(seu_fil) ## find the variable features
seu_fil <- ScaleData(seu_fil) ## scale the data
seu_fil <- RunPCA(seu_fil) # run linear dimensional reduction
seu_fil <- FindNeighbors(seu_fil, dims = 1:30) # find neighbours in order to cluster data 
seu_fil <- FindClusters(seu_fil, resolution = 0.9)  # need to use optimal resolution to cluster data so that transitioning cells or similar cells are not clumped together
seu_fil <- RunUMAP(seu_fil, dims = 1:30, n.neighbors = 50)

# visualise the data
DimPlot(seu_fil, reduction = "umap", group.by = "seurat_clusters", label = T)

# check whether resolution used to process data was optimal 
## use clusters 0, 1 and 4 to make a new dim plot
cells <- CellsByIdentities(seu_fil, idents = c(2, 3, 4))
SpatialDimPlot(seu_fil, cells.highlight = cells[setdiff(names(cells), "NA")], # check spatially where the clusters are (what tissue)
               cols.highlight = c("yellow", "grey50"),
               facet.highlight = T, combine = T)
## can use the spatial feature plot function to look at the spatial expression of a specific gene
SpatialFeaturePlot(seu_fil, features = "ACTG2")
## visualise myometrium, decidua and placenta cell gene markers in the cluster
FeaturePlot(object = seu_fil, 
            features = c("DES", "PRL", "CGA"), label = T, raster = FALSE)

SpatialFeaturePlot(seu_fil, features = "CYP19A1") + # gene marker for syncytiotrophoblasts (SCTs)
  SpatialFeaturePlot(seu_fil, features = "ERVW-1") # gene marker for villous cytotrophobasts (VCTs) + SCTs

SpatialFeaturePlot(seu_fil, features = "MME") + # gene symbol for fetal placenta SCT and VCT cells from GSEA database
SpatialFeaturePlot(seu_fil, features = "STAB2") # gene symbol for fetal placenta EVT cells from GSEA database
```

# identify marker genes
```{r}
# identify marker genes
markers <- FindAllMarkers(seu_fil, assay = "Spatial", only.pos = TRUE) 
# subset for the top marker genes for each cluster
markers %>%
  group_by(cluster) %>%
  dplyr::filter(avg_log2FC > 1) %>%
  slice_head(n = 5) %>%
  ungroup() -> top5
```

# load reference gene marker file
```{r}
vent_ref <- fread("/Users/taylaalbertini/Desktop/R studio/honours_project/placenta_spatial_annotating/rawData/vento_tormo_referenceMatrix.txt", 
                         header = TRUE,
                         sep = "\t")
# remove rows with all zeros
vent_ref <- vent_ref[rowSums(vent_ref[,-1])>0,]

# Check for duplicate column names
duplicated_colnames <- anyDuplicated(names(vent_ref))

if (duplicated_colnames) {
  # Make column names unique
  names(vent_ref) <- make.names(names(vent_ref), unique = TRUE)
}

## convert hgnc symbols into ensembl IDs 
library(org.Hs.eg.db)
top5$ensembl <- mapIds(org.Hs.eg.db, keys = top5$gene, keytype = "SYMBOL", column = "ENSEMBL")
view(top5)
```

# annotate the clusters
```{r}
# Function to annotate clusters
annotate_clusters <- function(markers, known_markers) {
  # Create an empty list to store annotations
  cluster_annotations <- list()
  
  # Iterate through each cluster
  for (cluster in unique(markers$cluster)) {
    # Get top markers for the cluster
    cluster_markers <- markers %>% filter(cluster == !!cluster)
    
    # Match these markers to the known_markers
    matched_markers <- known_markers %>% filter(GeneSymbol %in% cluster_markers$ensembl) ## only keeping GeneSymbols that match the top genes from marker df
    
    # Sum the counts for each cell type
    cell_type_sums <- colSums(matched_markers[, -1]) 
    
    # Find the cell type with the highest sum
    annotated_cell_type <- names(cell_type_sums)[which.max(cell_type_sums)]
    
    # Store the result
    cluster_annotations[[as.character(cluster)]] <- annotated_cell_type
  }
  
  return(cluster_annotations)
}

# Annotate clusters
cluster_annotations_2 <- annotate_clusters(top5, vent_ref)
```

# annotate Seurat Object based on the cluster annotations
```{r}
# create a vector of cluster labels
# remove numbers after the "."
## make a df and transform the df so that row names are clusters and cluster labels are a column
cluster_annotation <- as.data.frame(cluster_annotations_2) %>% 
  t() 
## set row and column names
rownames(cluster_annotation) <- c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9)
colnames(cluster_annotation) <- "cluster_labels"
## make rown names a column called "clusters"
cluster_annotation <- as.data.frame(cluster_annotation) %>% 
  tibble::rownames_to_column(., var = "cluster")
## remove the "." and everything after for cluster labels 
cluster_annotation <-mutate(cluster_annotation, cluster_labels = str_remove(cluster_labels, "\\..*")) %>% 
  dplyr::select(., cluster, cluster_labels)
## create a vector of the cluster labels
cluster_labels <- deframe(cluster_annotation)
print(cluster_labels)

# add cluster labels to Seurat object
seu_fil$cell_type <- seu_fil$seurat_clusters %>%
  as.character() %>%
  map_chr(~ cluster_labels[.])
print(seu_fil@meta.data$cell_type)

# Visualize the annotations
DimPlot(seu_fil, reduction = "umap", group.by = "cell_type")

SpatialDimPlot(seu_fil, group.by = "cell_type")
```

# genes of interest
```{r}
# List of genes of interest
genes_of_interest <- c("SIK1B", "CD44", "GSTM1", "HSD17B12", "IGFBP7", "MEIS1", "OSBPL8", "RERG", "HOXB2")  # Replace with your genes

# Visualize expression of genes of interest
SpatialFeaturePlot(seu_fil, features = genes_of_interest)

# Extract spatial coordinates and cell type annotations
spatial_data <- as.data.frame(seu_fil@images[[1]]@boundaries$centroids@coords)
spatial_data$barcode <- rownames(expression_data)
spatial_data$cell_type <- seu_fil$cell_type

# Extract gene expression data
expression_data <- as.data.frame(FetchData(seu_fil, vars = genes_of_interest))
expression_data$barcode <- rownames(expression_data)

# Merge spatial data with expression data
merged_data <- merge(spatial_data, expression_data, by = "barcode")


# Example plot for one gene
ggplot(merged_data, aes(x = x, y = y)) +
  geom_point(aes(color = HOXB2)) +  # Replace SIK1B with your gene of interest
  scale_color_gradient(low = "blue", high = "red") +
  theme_minimal() +
  labs(title = "Spatial Expression of HOXB2", color = "Expression")

# create plot for each gene
ggplot(merged_data, aes(x = x, y = y)) +
  geom_point(aes(color = HOXB2), size = 0.5) +  
  facet_wrap(~ cell_type) +
  scale_color_gradient(low = "yellow", high = "grey50") +
  theme_minimal() +
  labs(title = "Expression of HOXB2 by Cell Type", color = "Expression")

# Save the plot
output_dir <- "/Users/taylaalbertini/Desktop" # directory to save plots
ggsave(filename = paste0(output_dir, "/", gene, "_expression_plot.png"), plot = p)

# directory to save plots
output_dir <- "/Users/taylaalbertini/Desktop"

# Loop through each gene and generate the plot
for (gene in genes_of_interest) {
  # Create the plot
  p <- ggplot(merged_data, aes_string(x = x, y = y)) +
    geom_point(aes_string(color = gene), size = 0.5) +  
    facet_wrap(~ cell_type) +
    scale_color_gradient(low = "yellow", high = "grey50") +
    theme_bw() +
    labs(title = paste("Expression of", gene, "by Cell Type"), color = "Expression")
  
  # Save the plot
  ggsave(filename = paste0(output_dir, "/", gene, "_expression_plot.png"), plot = p)
}
```
